# 数据库PJ设计及使用说明

## 小组成员：谢子璇 张立凤
### 一、ER图

<img src="D:\谢子璇（大学）\数据库系统概念\谢子璇 张立凤er图.png" alt="谢子璇 张立凤er图" style="zoom:50%;" />

**对特殊设计的说明**：

主要是为了查询离校时间便捷，增加了`outside_time`实体，用于记录学生每天的离校总时长。

实现时，通过设定@Scheduled，使得每晚0点自动计算前一天离校的总时长，并转换成毫秒级保存到数据库中，这样在计算n天的离校总时长时，用空间换了时间。



## 测试说明：

在启动项目之前，请先按照提示修改application.properties文件中的username, password和url，这样启动之后可以直接在本机的mysql中建库建表输入数据。

系统针对不同的用户角色，设置的不同的功能。当开始运行后，项目的第一个页面是登录页面，你需要输入正确的学号或工号，以及选择对应的身份，登录成功后，将跳转到对角色的页面。

**建议学生登录使用20302010061（软工1班学生）；
辅导员登录使用12345678（软工1班辅导员）； 
院系管理员登录使用87654321（计算机科学技术学院管理员）；
超级管理员登录使用00000000**。

数据库中risky_place风险地区表记录的是“上海市 杨浦区 长海路街道”；
school表记录是"复旦大学 上海市"；
outside_time表记录了10位学生从2021-12-18日到2022-12-22日的每一天的离校时间；student表中，学号为203020的为计算机科学技术学院，2040的是物理学院，2050的是数学学院。

李四（20302010002）、王五（20302010003）、谢子璇（20302010061）、张立凤（20302010078）属于软工1班，辅导员用户名为12345678，计算机科学技术学院院系管理员用户名为87654321；

张三（20302010001）、李华（20302010077）、周子涵（20302010079）属于软工2班，辅导员用户名为12345679，计算机科学技术学院院系管理员用户名为87654321；

张三三（20202010001）属于化学1班，辅导员用户名为12345670，化学学院院系管理员用户名为87654420；

李四四（20402010002）属于物理1班，辅导员用户名为12345672，物理学院院系管理员用户名为87654520；

王五五（20502010003）属于数学1班，辅导员用户名为12345673，数学学院院系管理员用户名为87654620。

下面将分角色进行说明：

**1.学生**

学生的首页进行的个人信息展示，可以在此对学生的个人信息进行维护（除了学号，姓名，院系、班级以外）。

下一个功能组是健康日报、出入校申请的填写，只用填写需要的数据，默认数据由系统自动生成，填写提交之后， 可在数据库中查看填写情况，也可以通过学生的事物进度查询，进行查看新增的出入校申请，或者，在对应的辅导员或院系管理员中找到对应的学生，进行查看。

下一个是学生的刷卡功能，这里是为学生增加log记录，目前数据库已经为每一位学生都记录了一次log，为了后面的查询功能的正确，请先在超级管理员界面上完成查询功能的检测后，再对学生进行刷卡、填写健康日报和出入校申请。

最后是关于学生查询的功能组，包括**事物进度查询、入校权限查询、离校总时长查询、班级统计数据查询**。

事物进度查询是查看该学生的出入校申请的处理情况，对于出入校申请，我们设计了四种状态，分别是未处理、被拒绝、辅导员同意、已通过。对于被拒绝的出入校申请，学生可以查看被拒的原因。同时这里也支持按状态筛选，可以在选择器中选择筛选的状态，点击查询按钮即可。

班级统计数据，展示了当前本班级的共有人数，以及班级对每一个校区有权限的人数情况。

**2.辅导员**

辅导员的首页进行的是学生列表展示，在学生列表上，可以对每一个学生**过去n日健康日报、入校权限、出入校申请、一年的离校时长**进行查询。

下一个是事物处理的功能组。这里展示了本班级的所有学生的出入校申请，同时也支持按状态筛选。
对于辅导员和院系管理员，我们为其设置了检查的功能，但对辅导员来说，检查功能只有在出入校申请的状态未未处理时生效（这是为了保证事务处理的顺序，即：学生提交->辅导员审核->院系管理员审核）。
检查功能对于离校申请是检查该生前往的地方是否是为风险地区，对于出校申请是检查该生的七日内的健康日报填写情况。

最后一个功能组是统计数据以及查询功能。
统计数据展示的是本院系的所有班级的统计情况。包括班级辅导员，班级人数，以及该班级的权限情况。
查询功能实现了对本班级**前n个提交入校申请数最多的学生**，**前n个平均离校时间最长的学生**（这里的离校时间是数据库中的所有离校时间记录的总和，比一年内的离校时长要大）,**过去n天未曾出校的学生**的查询。

下面将给出全校的所有人的情况，您可以对照下表，对查询的结果进行确认。

数据库的原始数据中每人填写入校申请的次数如下图（全校），其余填写次数为0的人不做统计。每次返回的数据都是填写情况不为0的人数。也就是说当班级有4人，填写次数不为0的有两人，当n=4时，实际的返回情况只是填写次数不为0的那两人，如果n=5，也是填写次数不为0的那两人，如果这个2人的填写次数相同，当n=1的情况下，只会返回1人。

<img src="C:\Users\xiezi\AppData\Roaming\Typora\typora-user-images\image-20221225133753553.png" alt="image-20221225133753553" style="zoom:50%;" />

在原始数据的情况下，全校学生的离校总时长如下。

<img src="C:\Users\xiezi\AppData\Roaming\Typora\typora-user-images\image-20221225133858873.png" alt="image-20221225133858873" style="zoom:50%;" />

在原始数据的情况下，最后一次刷卡记录为进校的学生log情况时：

| 20302010061 | 谢子璇 | 2022-12-18 | 23:12:55 |
| ----------- | ------ | ---------- | -------- |
| 20302010079 | 周子涵 | 2022-12-20 | 15:52:00 |
| 20202010001 | 张三三 | 2022-12-22 | 22:15:43 |
| 20402010002 | 李四四 | 2022-12-22 | 11:15:43 |
| 20502010003 | 王五五 | 2022-12-22 | 16:15:43 |
| 20302010077 | 李华   | 2022-12-22 | 10:30:43 |
| 20302010002 | 李四   | 2022-12-23 | 17:41:35 |
| 20302010003 | 王五   | 2022-12-22 | 13:30:43 |

**3.院系管理员**

院系管理员的首页展示了班级列表，有当前院系的所有班级，包括班级的辅导员，以及人数。
列表的行下拉展开后时班级的所有学生，这里可以对学生进行**n日健康日报、入校权限、出入校申请、一年的离校时长进行查询**。
后面的查询功能可以在院系的范围内对**前n个提交入校申请数最多的学生，前n个平均离校时间最长的学生（这里的离校时间是数据库中的所有离校时间记录的总和，比一年内的离校时长要大）,过去n天未曾出校的学生学生进行查询**。可以根据上面给出的全校的情况，对查询结果进行确认。

下一个功能模块是对出入校申请进行审核，与辅导员不同的是，院系管理员的检查功能只有在申请的状态是辅导员同意的情况下开放，同样支持按状态查询。

**4.超级管理员**

超级管理员可以查看所有的院系（院系列表）以及对应院系中的所有学生。

超级管理员可以对校区进行管控，也就是更改校区的状态，当校区变为封控状态时，所有学生对该校区都失去入校权限。

最后是所有的查询功能实现。查询1延续的是辅导员和院系管理员的查询，讲查询范围改为了全校。同样的，结果可以通过上面的图进行比对。

查询2包括：

1.**过去n天尚未批准的出入校申请**（指从当前往前的n天的这个区间内未被批准申请）：
当前数据库中，入校申请的日期涵盖了12-02，12-19，12-20，12-21，12-23。离校申请的日期包括12-02，12-19，12-20；

2.**已经出校但尚未回校的学生数量、个人信息、以及离校时间**：
在数据库是原始数据的情况下，目前处于离校状态的学生只有张三（20302010001），张立凤（20302010078）；

3.**未提交出校申请但离校已经超过24h的学生数量和个人信息**：
在原始数据的情况下，只有张三（20302010001）满足，因为张三的离校时间记录是2022-12-22 17:35:04，且目前没有离校申请记录。

4.**已提交出校申请但未离校的学生数量和个人信息**：
这里查询的离校申请必须是已经被通过的离校申请，再根据离校申请来判断学生目前的是否满足要求，在原始数据的情况下，满足的查询要求的只有谢子璇（20302010061），谢子璇的最后一个被通过的离校申请是2022-12-20日的离校申请，预期离校的时间是2022-12-20，预期返回的时间是2023-1-19日，在此期间，查询到log的最后一条记录是2022-12-18的进校记录，说明一直未曾离校，因此满足查询条件。

5.**连续n天提交健康日报时间完全一致的学生**：
原始数据下，周子涵(20302010079)有9天连续完全一致的健康日报记录，
张三三（20202010001），谢子璇（20302010061），李四四（20402010002），王五五（20502010003）有3天连续完全一致的健康日报记录。

6.**过去n天每个院系学生产生最多的出入记录的校区**：
在原始数据的情况下，log的最后一次记录是2022-12-23，因此查询时过去n天的范围需要涵盖2022-12-23，才会有数据记录，如果涵盖到12-02日（log第一条记录）,每个学院对应的校区都是邯郸校区。





